# Roguelike Run Mode - Game Design Document

## Overview

Roguelike Run — это режим прогрессии, где игроки проходят забеги с целью набрать 9 побед до 4 поражений. Игроки строят колоду через систему фракций, лидеров и драфта.

---

## Основные отличия от MVP

| Аспект | MVP | Roguelike Run |
|--------|-----|---------------|
| Фракции | 1 (общая) | 6 фракций, 25 юнитов каждая |
| Лидеры | Нет | 18 лидеров (3 на фракцию) |
| Заклинания | Нет | 2 заклинания в колоде |
| Размер колоды | N/A | 14 карт (12 юнитов + 2 заклинания) |
| Сетка | 8×10 | 8×2 (зона высадки) |
| Бюджет | 30 фиксированный | 10g → 65g прогрессия |
| Тиры юнитов | Нет | T1 → T2 → T3 апгрейды |
| Режим игры | Одиночный бой | Забег 9 побед / 4 поражения |
| Матчмейкинг | PvP очередь | Асинхронный vs снапшоты |

---

## Фракции

### Phase 1 (2 фракции)

| Фракция | Тема | Бонус |
|---------|------|-------|
| **Humans** | Рыцари, Паладины, Лучники | +10% HP |
| **Undead** | Скелеты, Зомби, Личи | +15% ATK |

### Phase 2+ (6 фракций, планируется)

| Фракция | Тема | Бонус |
|---------|------|-------|
| **Order** | Рыцари, Паладины | +10% HP |
| **Chaos** | Демоны, Чернокнижники | +15% ATK |
| **Nature** | Друиды, Звери | +10% Регенерация |
| **Shadow** | Убийцы, Разбойники | +20% Уклонение |
| **Arcane** | Маги, Элементали | +15% Магический урон |
| **Machine** | Конструкты, Инженеры | +15% Броня |

### Юниты на фракцию (Phase 1)
- 12 юнитов на фракцию (24 всего)
- Распределение по ролям: Tank (3), Melee DPS (3), Ranged DPS (3), Mage (2), Support (1)
- Тиры: T1 (базовый), T2 (+50% статы), T3 (+100% статы + способность)

---

## Лидеры

### Структура лидера
```typescript
interface Leader {
  id: string;
  name: string;
  nameRu: string;
  faction: Faction;
  passive: PassiveAbility;  // Всегда активна
  spells: Spell[];          // 2 заклинания
  portrait: string;
}
```

### Phase 1 Лидеры (6 — по 3 на фракцию)

#### Humans
| Лидер | Пассивка | Заклинания |
|-------|----------|------------|
| Командор Алдрик | +10% HP всем союзникам | Holy Light, Rally |
| Леди Элара | +15% исцеление | Blessing, Divine Shield |
| Сэр Галахад | Первый юнит получает таунт | Smite, Fortify |

#### Undead
| Лидер | Пассивка | Заклинания |
|-------|----------|------------|
| Лич-Король Малахар | +15% ATK при HP < 50% | Death Coil, Raise Dead |
| Леди Сильвана | +10% вампиризм | Soul Drain, Dark Pact |
| Некромант Кел'Тузад | Призывает скелета при смерти союзника | Frost Nova, Corpse Explosion |

---

## Система заклинаний

### Структура заклинания
```typescript
interface Spell {
  id: string;
  name: string;
  effect: SpellEffect;
  timing: 'early' | 'mid' | 'late';  // Выбирает игрок
}
```

### Тайминг заклинаний (по HP порогам)
| Тайминг | Триггер |
|---------|---------|
| Early | Сразу в начале боя |
| Mid | Когда любой союзник падает ниже 70% HP |
| Late | Когда любой союзник падает ниже 40% HP |

```typescript
const SPELL_TIMING_THRESHOLDS = {
  early: 1.0,   // Triggers immediately at battle start
  mid: 0.7,    // Triggers when any ally drops below 70% HP
  late: 0.4,   // Triggers when any ally drops below 40% HP
};
```

### Примеры заклинаний
| Заклинание | Эффект |
|------------|--------|
| Holy Light | Восстанавливает 30 HP союзнику с наименьшим HP |
| Rally | +20% ATK всем союзникам на 3 раунда |
| Death Coil | 40 урона врагу + 20 HP себе |
| Raise Dead | Призывает скелета-воина |

---

## Колода и рука

### Терминология
| Термин | Описание |
|--------|----------|
| **Deck** | Стартовая колода из 12 юнитов (фиксирована для фракции) |
| **Hand** | Юниты доступные для размещения (3-12 карт) |
| **Remaining Deck** | Карты ещё не задрафченные в руку |

### Структура колоды
- **Максимум**: 12 юнитов + 2 заклинания
- **Начальная рука**: 3 карты (после initial draft)
- **Рост руки**: +1 карта после каждого боя (post-battle draft)

### Карта колоды
```typescript
interface DeckCard {
  instanceId: string;  // Уникальный ID экземпляра
  unitId: string;      // ID типа юнита
  tier: 1 | 2 | 3;     // Текущий тир
}
```

### Прогрессия драфта

| После боя | Remaining Deck | Hand Size |
|-----------|----------------|-----------|
| Старт | 12 юнитов | 0 |
| Initial Draft | 9 юнитов | 3 |
| Бой 1 | 8 юнитов | 4 |
| Бой 2 | 7 юнитов | 5 |
| ... | ... | ... |
| Бой 9 | 0 юнитов | 12 |

---

## Драфт

### Начальный драфт
1. Показать 5 случайных карт из пула фракции
2. Игрок выбирает 3 карты
3. Карты идут в руку

### Драфт после боя
1. Показать 3 случайные карты из пула фракции
2. Игрок выбирает 1 карту
3. Карта добавляется в руку

---

## Система апгрейдов

### Прогрессия тиров
| Тир | Статы | Стоимость апгрейда |
|-----|-------|-------------------|
| T1 | Базовые (100%) | - |
| T2 | +50% все статы | 100% от T1 cost |
| T3 | +100% все статы + способность | 150% от T1 cost (округлённо) |

### Примеры стоимости апгрейда

| Юнит | T1 Cost | T1→T2 | T2→T3 | Всего до T3 |
|------|---------|-------|-------|-------------|
| Пехотинец (3g) | 3g | 3g | 5g | 11g |
| Рыцарь (5g) | 5g | 5g | 8g | 18g |
| Паладин (7g) | 7g | 7g | 11g | 25g |

### Правила апгрейда
- Можно апгрейдить только карты в руке
- Последовательно: T1 → T2 → T3
- Визуальный индикатор тира (цвет рамки)
- Юниты нельзя продавать, только перемещать

---

## Прогрессия бюджета

| Бой # | Бюджет |
|-------|--------|
| 1-2 | 10g |
| 3-4 | 20g |
| 5-6 | 35g |
| 7-8 | 50g |
| 9+ | 65g |

---

## Экономика золота

| Событие | Золото |
|---------|--------|
| Победа | 7g базово |
| Поражение | 9g (catch-up механика) |
| Серия побед (3+) | +2g за каждую победу в серии |

### Формула награды
```typescript
// Starting gold: 10g
// Win reward: +7g + streak bonus
// Lose reward: +9g (catch-up mechanic)

function getGoldReward(won: boolean, winStreak: number): number {
  if (!won) return 9;  // Lose: 9g (catch-up mechanic)
  
  const base = 7;  // Win: 7g base
  const streakBonus = winStreak >= 3 ? (winStreak - 2) * 2 : 0;
  return base + streakBonus;
}
```

### Примеры начисления золота

| Бой | Результат | Золото | Всего |
|-----|-----------|--------|-------|
| Старт | - | 10g | 10 |
| 1 | Победа | +7g | 17 |
| 2 | Победа | +7g | 24 |
| 3 | Поражение | +9g | 33 |
| 4 | Поражение | +9g | 42 |
| 5 | Победа | +7g | 49 |
| 6 | Победа (3-streak) | +9g | 58 |

---

## Сетка боя

### Зона высадки (размещение)
- Размер: 8×2 (ширина × высота)
- Игрок размещает юнитов в 2 ряда (rows 0-1)
- Противник размещается в rows 8-9

### Боевая сетка (симуляция)
- Размер: 8×10 (как в MVP)
- Юниты игрока: ряды 0-1
- Юниты противника: ряды 8-9

```typescript
const ROGUELIKE_GRID_CONFIG: GridConfig = {
  width: 8,
  height: 10,  // Full battle grid
  playerRows: [0, 1],  // 2 rows for deployment (8×2 zone)
  enemyRows: [8, 9],   // Enemy deployment zone
};
```

---

## Асинхронный PvP

### Система снапшотов
1. После каждого боя сохраняется снапшот команды
2. Матчмейкинг против снапшотов других игроков
3. Детерминированная симуляция (один seed = один результат)

### Алгоритм матчмейкинга
```typescript
async function findOpponent(run: Run): Promise<Snapshot | null> {
  // 1. Найти снапшоты с похожим числом побед
  const candidates = await findByWins(run.wins - 1, run.wins + 1);
  
  // 2. Фильтр по рейтингу (±200)
  const filtered = candidates.filter(s => 
    Math.abs(s.rating - run.rating) <= 200
  );
  
  // 3. Случайный выбор
  if (filtered.length > 0) {
    return randomChoice(filtered);
  }
  
  // 4. Fallback: бот
  return generateBot(run.wins);
}
```

---

## Рейтинговая система

### Расчёт рейтинга (ELO)
```typescript
function calculateRatingChange(
  playerRating: number,
  opponentRating: number,
  won: boolean
): number {
  const K = 32;
  const expected = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
  const actual = won ? 1 : 0;
  return Math.round(K * (actual - expected));
}
```

### Лиги
| Лига | Рейтинг |
|------|---------|
| Bronze | 0-999 |
| Silver | 1000-1499 |
| Gold | 1500-1999 |
| Platinum | 2000-2499 |
| Diamond | 2500+ |

---

## Условия завершения забега

### Победа (9 побед)
- Экран победы
- Награды в зависимости от поражений
- Обновление рейтинга игрока

### Поражение (4 поражения)
- Экран поражения
- Обновление рейтинга
- Кнопка "Новый забег"

---

## UI Flow

### Старт забега
```
[Главное меню] 
    │
    ▼
[Выбор фракции] ─── 6 карт фракций с бонусами
    │
    ▼
[Выбор лидера] ─── 3 карты лидеров с пассивками
    │
    ▼
[Начальный драфт] ─── Выбрать 3 из 5 карт
    │
    ▼
[Подготовка к бою] ─── Расставить юнитов, выбрать тайминг заклинаний
```

### Цикл боя
```
[Подготовка к бою]
    │
    ├── Расставить юнитов на сетке 8×2
    ├── Выбрать тайминг заклинаний
    └── Нажать "В бой"
    │
    ▼
[Реплей боя] ─── Анимация боя
    │
    ▼
[Результат] ─── Победа/Поражение, заработанное золото
    │
    ├── Если 9 побед → [Экран победы]
    ├── Если 4 поражения → [Экран поражения]
    └── Иначе ↓
    │
    ▼
[Драфт] ─── Выбрать 1 из 3 карт
    │
    ▼
[Магазин апгрейдов] ─── Опциональные апгрейды
    │
    ▼
[Подготовка к бою] ─── Цикл повторяется
```

---

## Технические требования

### Зависимости
- Core extraction должен быть завершён
- Grid система должна поддерживать настраиваемые размеры
- Battle simulator должен поддерживать заклинания и пассивки лидеров

### Новые сущности БД
- `runs` — сущность забега
- `factions` — определения фракций
- `leaders` — определения лидеров
- `faction_units` — юниты по фракциям
- `spells` — определения заклинаний
- `snapshots` — снапшоты команд для матчмейкинга

### Новые API endpoints
- `POST /api/runs` — создать забег
- `GET /api/runs/:id` — получить состояние забега
- `GET /api/runs/:id/draft` — получить опции драфта
- `POST /api/runs/:id/draft` — отправить выбор драфта
- `POST /api/runs/:id/battle` — начать бой
- `POST /api/runs/:id/shop/upgrade` — апгрейд карты

---

## Вне скоупа (Фаза 1)

- Несколько слотов сохранения
- UI лидербордов
- Достижения
- Косметика/скины
- Турнирный режим
- Режим наблюдателя
