# Roguelike Run Mode - Game Design Document

## Overview

Roguelike Run — это режим прогрессии, где игроки проходят забеги с целью набрать 9 побед до 4 поражений. Игроки строят колоду через систему фракций, лидеров и драфта.

---

## Основные отличия от MVP

| Аспект | MVP | Roguelike Run |
|--------|-----|---------------|
| Фракции | 1 (общая) | 6 фракций, 25 юнитов каждая |
| Лидеры | Нет | 18 лидеров (3 на фракцию) |
| Заклинания | Нет | 2 заклинания в колоде |
| Размер колоды | N/A | 14 карт (12 юнитов + 2 заклинания) |
| Сетка | 8×10 | 8×2 (зона высадки) |
| Бюджет | 30 фиксированный | 10g → 65g прогрессия |
| Тиры юнитов | Нет | T1 → T2 → T3 апгрейды |
| Режим игры | Одиночный бой | Забег 9 побед / 4 поражения |
| Матчмейкинг | PvP очередь | Асинхронный vs снапшоты |

---

## Фракции (6)

| Фракция | Тема | Бонус |
|---------|------|-------|
| **Order** | Рыцари, Паладины | +10% HP |
| **Chaos** | Демоны, Чернокнижники | +15% ATK |
| **Nature** | Друиды, Звери | +10% Регенерация |
| **Shadow** | Убийцы, Разбойники | +20% Уклонение |
| **Arcane** | Маги, Элементали | +15% Магический урон |
| **Machine** | Конструкты, Инженеры | +15% Броня |

### Юниты на фракцию
- 25 юнитов на фракцию (150 всего)
- Распределение по ролям: Tank, Melee DPS, Ranged DPS, Mage, Support, Control
- Тиры: T1 (обычный), T2 (редкий), T3 (эпический)

---

## Лидеры (18)

### Структура лидера
```typescript
interface Leader {
  id: string;
  name: string;
  faction: Faction;
  passive: PassiveAbility;  // Всегда активна
  spells: Spell[];          // 2 заклинания на выбор
  portrait: string;
}
```

### Примеры лидеров

#### Order
| Лидер | Пассивка | Заклинания |
|-------|----------|------------|
| Командор Аврелий | +5% HP всем союзникам | Divine Shield, Mass Heal |
| Леди Изольда | +10% исцеление | Blessing, Resurrection |
| Сэр Галахад | Таунт на первом юните | Holy Strike, Fortify |

#### Chaos
| Лидер | Пассивка | Заклинания |
|-------|----------|------------|
| Лорд Малгарот | +10% ATK при HP < 50% | Hellfire, Soul Drain |
| Ведьма Моргана | +5% вампиризм | Curse, Dark Pact |
| Демон Азраэль | Игнорирует 10% брони | Chaos Bolt, Inferno |

---

## Система заклинаний

### Структура заклинания
```typescript
interface Spell {
  id: string;
  name: string;
  effect: SpellEffect;
  timing: 'early' | 'mid' | 'late';  // Выбирает игрок
}
```

### Тайминг заклинаний
| Тайминг | Триггер |
|---------|---------|
| Early | Раунды 1-3 |
| Mid | Раунды 4-6 |
| Late | Раунды 7+ |

### Примеры заклинаний
| Заклинание | Эффект |
|------------|--------|
| Divine Shield | Щит на 50% HP первому юниту |
| Hellfire | 20 урона всем врагам |
| Mass Heal | +30 HP всем союзникам |
| Curse | -20% ATK всем врагам на 2 раунда |

---

## Колода и рука

### Структура колоды
- **Максимум**: 14 карт (12 юнитов + 2 заклинания)
- **Начальная рука**: 3 карты
- **Рост руки**: +1 карта после каждого боя

### Карта колоды
```typescript
interface DeckCard {
  unitId: string;
  tier: 1 | 2 | 3;
  isSpell?: boolean;
}
```

---

## Драфт

### Начальный драфт
1. Показать 5 случайных карт из пула фракции
2. Игрок выбирает 3 карты
3. Карты идут в руку

### Драфт после боя
1. Показать 3 случайные карты из пула фракции
2. Игрок выбирает 1 карту
3. Карта добавляется в руку

---

## Система апгрейдов

### Прогрессия тиров
| Тир | Статы | Стоимость |
|-----|-------|-----------|
| T1 | Базовые | Бесплатно |
| T2 | +25% все статы | 5g |
| T3 | +50% все статы | 10g |

### Правила апгрейда
- Можно апгрейдить только карты в руке
- Последовательно: T1 → T2 → T3
- Визуальный индикатор тира (цвет рамки)

---

## Прогрессия бюджета

| Бой # | Бюджет |
|-------|--------|
| 1-2 | 10g |
| 3-4 | 20g |
| 5-6 | 35g |
| 7-8 | 50g |
| 9+ | 65g |

---

## Экономика золота

| Событие | Золото |
|---------|--------|
| Победа | 5g + бонус за серию |
| Поражение | 2g |
| Серия побед (3+) | +2g за каждую победу в серии |

### Формула награды
```typescript
function getGoldReward(won: boolean, winStreak: number): number {
  if (!won) return 2;
  const base = 5;
  const streakBonus = winStreak >= 3 ? (winStreak - 2) * 2 : 0;
  return base + streakBonus;
}
```

---

## Сетка боя

### Зона высадки (размещение)
- Размер: 8×2 (ширина × высота)
- Игрок размещает юнитов в 2 ряда

### Боевая сетка (симуляция)
- Размер: 8×10 (как в MVP)
- Юниты игрока: ряды 0-1
- Юниты противника: ряды 8-9

---

## Асинхронный PvP

### Система снапшотов
1. После каждого боя сохраняется снапшот команды
2. Матчмейкинг против снапшотов других игроков
3. Детерминированная симуляция (один seed = один результат)

### Алгоритм матчмейкинга
```typescript
async function findOpponent(run: Run): Promise<Snapshot | null> {
  // 1. Найти снапшоты с похожим числом побед
  const candidates = await findByWins(run.wins - 1, run.wins + 1);
  
  // 2. Фильтр по рейтингу (±200)
  const filtered = candidates.filter(s => 
    Math.abs(s.rating - run.rating) <= 200
  );
  
  // 3. Случайный выбор
  if (filtered.length > 0) {
    return randomChoice(filtered);
  }
  
  // 4. Fallback: бот
  return generateBot(run.wins);
}
```

---

## Рейтинговая система

### Расчёт рейтинга (ELO)
```typescript
function calculateRatingChange(
  playerRating: number,
  opponentRating: number,
  won: boolean
): number {
  const K = 32;
  const expected = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
  const actual = won ? 1 : 0;
  return Math.round(K * (actual - expected));
}
```

### Лиги
| Лига | Рейтинг |
|------|---------|
| Bronze | 0-999 |
| Silver | 1000-1499 |
| Gold | 1500-1999 |
| Platinum | 2000-2499 |
| Diamond | 2500+ |

---

## Условия завершения забега

### Победа (9 побед)
- Экран победы
- Награды в зависимости от поражений
- Обновление рейтинга игрока

### Поражение (4 поражения)
- Экран поражения
- Обновление рейтинга
- Кнопка "Новый забег"

---

## UI Flow

### Старт забега
```
[Главное меню] 
    │
    ▼
[Выбор фракции] ─── 6 карт фракций с бонусами
    │
    ▼
[Выбор лидера] ─── 3 карты лидеров с пассивками
    │
    ▼
[Начальный драфт] ─── Выбрать 3 из 5 карт
    │
    ▼
[Подготовка к бою] ─── Расставить юнитов, выбрать тайминг заклинаний
```

### Цикл боя
```
[Подготовка к бою]
    │
    ├── Расставить юнитов на сетке 8×2
    ├── Выбрать тайминг заклинаний
    └── Нажать "В бой"
    │
    ▼
[Реплей боя] ─── Анимация боя
    │
    ▼
[Результат] ─── Победа/Поражение, заработанное золото
    │
    ├── Если 9 побед → [Экран победы]
    ├── Если 4 поражения → [Экран поражения]
    └── Иначе ↓
    │
    ▼
[Драфт] ─── Выбрать 1 из 3 карт
    │
    ▼
[Магазин апгрейдов] ─── Опциональные апгрейды
    │
    ▼
[Подготовка к бою] ─── Цикл повторяется
```

---

## Технические требования

### Зависимости
- Core extraction должен быть завершён
- Grid система должна поддерживать настраиваемые размеры
- Battle simulator должен поддерживать заклинания и пассивки лидеров

### Новые сущности БД
- `runs` — сущность забега
- `factions` — определения фракций
- `leaders` — определения лидеров
- `faction_units` — юниты по фракциям
- `spells` — определения заклинаний
- `snapshots` — снапшоты команд для матчмейкинга

### Новые API endpoints
- `POST /api/runs` — создать забег
- `GET /api/runs/:id` — получить состояние забега
- `GET /api/runs/:id/draft` — получить опции драфта
- `POST /api/runs/:id/draft` — отправить выбор драфта
- `POST /api/runs/:id/battle` — начать бой
- `POST /api/runs/:id/shop/upgrade` — апгрейд карты

---

## Вне скоупа (Фаза 1)

- Несколько слотов сохранения
- UI лидербордов
- Достижения
- Косметика/скины
- Турнирный режим
- Режим наблюдателя
